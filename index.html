<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>.22 and Rifle Range Booking System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }

    body {
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    header {
      background-color: #2c3e50;
      color: #fff;
      padding: 20px;
      text-align: center;
      margin-bottom: 30px;
      border-radius: 5px;
    }

    .booking-section {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      margin-bottom: 30px;
    }

    .form-container, .bookings-container {
      background-color: #fff;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      flex: 1;
    }

    h2 {
      margin-bottom: 20px;
      color: #2c3e50;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }

    form {
      display: flex;
      flex-direction: column;
    }

    label {
      margin-bottom: 5px;
      font-weight: bold;
    }

    input, select {
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      background-color: #2c3e50;
      color: #fff;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      border-radius: 4px;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #1a252f;
    }

    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }

    .booking-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .booking-item:last-child {
      border-bottom: none;
    }

    .booking-details {
      flex: 1;
    }

    .booking-actions button {
      padding: 8px 12px;
      background-color: #e74c3c;
    }

    .error-message {
      color: #e74c3c;
      font-weight: bold;
      margin-top: 10px;
      display: none;
    }

    .loading {
      text-align: center;
      padding: 20px;
      font-style: italic;
      color: #7f8c8d;
    }

    .slots-container {
      margin-top: 20px;
    }

    .time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .slot {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .slot:hover:not(.slot-full) {
      background-color: #ecf0f1;
    }

    .slot.selected {
      background-color: #3498db;
      color: white;
      border-color: #2980b9;
    }

    .slot-full {
      background-color: #f5f5f5;
      color: #95a5a6;
      cursor: not-allowed;
      text-decoration: line-through;
    }

    .capacity-indicator {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      font-size: 0.8em;
    }

    .capacity-bar {
      height: 5px;
      width: 100%;
      background-color: #ecf0f1;
      border-radius: 2px;
      margin-top: 5px;
      overflow: hidden;
    }

    .capacity-fill {
      height: 100%;
      background-color: #2ecc71;
      transition: width 0.3s;
    }

    .capacity-warning .capacity-fill {
      background-color: #f39c12;
    }

    .capacity-full .capacity-fill {
      background-color: #e74c3c;
    }

    .field-hint {
      font-size: 0.8em;
      color: #666;
      margin-top: -10px;
      margin-bottom: 15px;
    }

    .view-bookings-form {
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }

    @media (max-width: 768px) {
      .booking-section {
        flex-direction: column;
      }

      .time-slots {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>.22 and Rifle Range Booking System</h1>
    <p>Book your shooting sessions online</p>
  </header>

  <div class="booking-section">
    <div class="form-container">
      <h2>Make a Booking</h2>
      <form id="booking-form">
        <label for="name">Full Name:</label>
        <input type="text" id="name" required>

        <label for="email">Email:</label>
        <input type="email" id="email" required>

        <label for="booking-password">Booking Password:</label>
        <input type="password" id="booking-password" required>
        <p class="field-hint">Create a password to securely manage your booking later.</p>

        <label for="date">Date:</label>
        <input type="date" id="date" required>

        <label for="range-type">Range Type:</label>
        <select id="range-type" required>
          <option value="">Select range type</option>
          <option value=".22 Range">.22 Range</option>
          <option value="Rifle Range">Rifle Range</option>
        </select>

        <div class="slots-container">
          <label>Available Time Slots:</label>
          <div id="time-slots" class="time-slots">
            <div class="loading">Select a date and range type to see available slots</div>
          </div>
        </div>

        <div id="error-message" class="error-message"></div>

        <button type="button" id="book-button" disabled>Book Range Time</button>
      </form>
    </div>

    <div class="bookings-container">
      <h2>Your Bookings</h2>
      <div class="view-bookings-form">
        <label for="view-email">Email:</label>
        <input type="email" id="view-email">

        <label for="view-password">Booking Password:</label>
        <input type="password" id="view-password">

        <button type="button" id="view-bookings-button">View My Bookings</button>
      </div>

      <div id="bookings-list">
        <p>Enter your email and password to view your bookings.</p>
      </div>
    </div>
  </div>
</div>

<script>
  // API endpoint - update this URL to your Netlify function
  // When developing locally, use: const API_URL = 'http://localhost:8888/.netlify/functions/bookings';
  // When deployed to production, use: const API_URL = 'https://your-netlify-site.netlify.app/.netlify/functions/bookings';
  // OR if you've set up redirects in netlify.toml: const API_URL = '/api/bookings';
  const API_URL = 'https://kraaifonteinrangebookings.netlify.app/.netlify/functions/bookings';

  // Configuration
  const MAX_CAPACITY = {
    ".22 Range": 5,  // 5 people per time slot
    "Rifle Range": 3 // 3 people per time slot
  };

  const TIME_SLOTS = [
    "09:00-10:00",
    "10:00-11:00",
    "11:00-12:00",
    "12:00-13:00",
    "13:00-14:00",
    "14:00-15:00",
    "15:00-16:00",
    "16:00-17:00"
  ];

  // Get DOM elements
  const bookButton = document.getElementById('book-button');
  const bookingsList = document.getElementById('bookings-list');
  const nameInput = document.getElementById('name');
  const emailInput = document.getElementById('email');
  const dateInput = document.getElementById('date');
  const rangeTypeInput = document.getElementById('range-type');
  const timeSlotsContainer = document.getElementById('time-slots');
  const errorMessage = document.getElementById('error-message');

  // Set minimum date to today
  const today = new Date().toISOString().split('T')[0];
  dateInput.setAttribute('min', today);

  // User state
  let currentUser = null;
  let selectedTimeSlot = null;
  let availabilityData = {};

  // Add event listeners
  document.addEventListener('DOMContentLoaded', initialize);
  dateInput.addEventListener('change', checkAvailability);
  rangeTypeInput.addEventListener('change', checkAvailability);
  bookButton.addEventListener('click', createBooking);
  document.getElementById('view-bookings-button').addEventListener('click', viewBookingsWithPassword);

  // Initialize application
  async function initialize() {
    // Check if user is already logged in (via email and session has password)
    const storedEmail = localStorage.getItem('rangeBookingEmail');
    const storedPassword = sessionStorage.getItem('rangeBookingPassword');

    if (storedEmail) {
      emailInput.value = storedEmail;
      document.getElementById('view-email').value = storedEmail;

      const storedName = localStorage.getItem('rangeBookingName');
      if (storedName) nameInput.value = storedName;

      // If we have both email and password in storage, try to verify and show bookings
      if (storedPassword) {
        document.getElementById('view-password').value = storedPassword;
        await viewBookingsWithPassword(); // Use password verification flow
      } else {
        // Just show the prompt to enter password
        bookingsList.innerHTML = '<p>Enter your email and password to view your bookings.</p>';
      }
    } else {
      bookingsList.innerHTML = '<p>Enter your email and password to view your bookings.</p>';
    }

    // Add event listener for user identification
    emailInput.addEventListener('blur', async function() {
      if (emailInput.validity.valid && emailInput.value) {
        localStorage.setItem('rangeBookingEmail', emailInput.value);
        if (nameInput.value) {
          localStorage.setItem('rangeBookingName', nameInput.value);
        }
        await getUserBookings(emailInput.value);
      }
    });
  }

  // New function to view bookings with password
  async function viewBookingsWithPassword() {
    const email = document.getElementById('view-email').value;
    const password = document.getElementById('view-password').value;

    if (!email || !password) {
      alert('Please enter both email and password');
      return;
    }

    // Store email but not password
    localStorage.setItem('rangeBookingEmail', email);

    bookingsList.innerHTML = '<p class="loading">Verifying credentials...</p>';

    try {
      // Get bookings with password verification
      const response = await fetch(`${API_URL}/verify?email=${encodeURIComponent(email.toLowerCase())}&password=${encodeURIComponent(password)}`);

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to verify credentials');
      }

      const data = await response.json();

      // Save view password in session storage only (more secure than localStorage)
      // This allows it to persist only until browser is closed
      sessionStorage.setItem('rangeBookingPassword', password);

      renderUserBookings(data || []);
    } catch (err) {
      console.error('Error fetching user bookings:', err);
      bookingsList.innerHTML = '<p class="error">Invalid email or password. Please try again.</p>';
    }
  }

  // Check availability for selected date and range type
  async function checkAvailability() {
    // Reset state
    timeSlotsContainer.innerHTML = '<div class="loading">Loading available slots...</div>';
    selectedTimeSlot = null;
    bookButton.disabled = true;
    errorMessage.style.display = 'none';

    const date = dateInput.value;
    const rangeType = rangeTypeInput.value;

    if (!date || !rangeType) {
      timeSlotsContainer.innerHTML = '<div class="loading">Select a date and range type to see available slots</div>';
      return;
    }

    try {
      // Get bookings for the selected date and range type from our Netlify function
      const response = await fetch(`${API_URL}?date=${date}&rangeType=${encodeURIComponent(rangeType)}`);

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to load availability');
      }

      const data = await response.json();

      // Process availability
      renderTimeSlots(data || [], date, rangeType);
    } catch (err) {
      console.error('Error checking availability:', err);
      errorMessage.textContent = err.message || 'Failed to load availability. Please try again.';
      errorMessage.style.display = 'block';
      timeSlotsContainer.innerHTML = '';
    }
  }

  // Render time slots with availability information
  function renderTimeSlots(bookings, date, rangeType) {
    timeSlotsContainer.innerHTML = '';

    // Group bookings by time slot
    const bookingsBySlot = {};
    TIME_SLOTS.forEach(slot => {
      bookingsBySlot[slot] = 0;
    });

    // Count bookings per slot
    bookings.forEach(booking => {
      if (bookingsBySlot.hasOwnProperty(booking.time_slot)) {
        bookingsBySlot[booking.time_slot]++;
      }
    });

    // Create slot elements
    TIME_SLOTS.forEach(timeSlot => {
      const slot = document.createElement('div');
      const bookedCount = bookingsBySlot[timeSlot];
      const maxCapacity = MAX_CAPACITY[rangeType];
      const isFull = bookedCount >= maxCapacity;

      slot.className = `slot ${isFull ? 'slot-full' : ''}`;
      slot.dataset.timeSlot = timeSlot;

      // Calculate capacity percentage
      const capacityPercentage = (bookedCount / maxCapacity) * 100;
      let capacityClass = '';

      if (capacityPercentage >= 100) {
        capacityClass = 'capacity-full';
      } else if (capacityPercentage >= 70) {
        capacityClass = 'capacity-warning';
      }

      slot.innerHTML = `
        <div>${formatTimeSlot(timeSlot)}</div>
        <div class="capacity-indicator">
          <span>${bookedCount}/${maxCapacity} booked</span>
        </div>
        <div class="capacity-bar ${capacityClass}">
          <div class="capacity-fill" style="width: ${Math.min(capacityPercentage, 100)}%"></div>
        </div>
      `;

      if (!isFull) {
        slot.addEventListener('click', () => selectTimeSlot(slot, timeSlot));
      }

      timeSlotsContainer.appendChild(slot);
    });

    if (timeSlotsContainer.children.length === 0) {
      timeSlotsContainer.innerHTML = '<p>No time slots available for the selected date.</p>';
    }
  }

  // Select a time slot
  function selectTimeSlot(slotElement, timeSlot) {
    // Remove selection from all slots
    document.querySelectorAll('.slot.selected').forEach(el => {
      el.classList.remove('selected');
    });

    // Add selection to clicked slot
    slotElement.classList.add('selected');
    selectedTimeSlot = timeSlot;

    // Enable booking button
    bookButton.disabled = false;
  }

  // Create a new booking
  async function createBooking() {
    if (!validateForm()) return;

    const name = nameInput.value;
    const email = emailInput.value;
    const date = dateInput.value;
    const rangeType = rangeTypeInput.value;
    const password = document.getElementById('booking-password').value;

    if (!password || password.length < 4) {
      errorMessage.textContent = 'Please enter a password (minimum 4 characters)';
      errorMessage.style.display = 'block';
      return;
    }

    // Show loading state
    bookButton.disabled = true;
    bookButton.textContent = 'Processing...';
    errorMessage.style.display = 'none';

    try {
      // Create the booking through our Netlify function
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: name,
          email: email.toLowerCase(),
          date: date,
          rangeType: rangeType,
          timeSlot: selectedTimeSlot,
          password_hash: password
        })
      });

      // Handle different response statuses
      if (response.status === 409) {
        throw new Error('This time slot is now fully booked. Please select another time.');
      }

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to create booking');
      }

      const data = await response.json();

      // Store user info
      localStorage.setItem('rangeBookingEmail', email);
      localStorage.setItem('rangeBookingName', name);

      // Reset form and show success
      resetForm();
      alert('Booking confirmed!');

      // Refresh user bookings
      await getUserBookings(email);

    } catch (err) {
      console.error('Error creating booking:', err);
      errorMessage.textContent = err.message || 'Failed to create booking. Please try again.';
      errorMessage.style.display = 'block';
    } finally {
      bookButton.disabled = false;
      bookButton.textContent = 'Book Range Time';
    }
  }

  // Get user bookings
  async function getUserBookings(email) {
    if (!email) return;

    bookingsList.innerHTML = '<p class="loading">Loading your bookings...</p>';

    try {
      // Fetch user bookings from our Netlify function
      const response = await fetch(`${API_URL}?email=${encodeURIComponent(email.toLowerCase())}`);

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to load bookings');
      }

      const data = await response.json();
      renderUserBookings(data || []);
    } catch (err) {
      console.error('Error fetching user bookings:', err);
      bookingsList.innerHTML = '<p>Failed to load your bookings. Please try again.</p>';
    }
  }

  // Render user bookings
  function renderUserBookings(bookings) {
    bookingsList.innerHTML = '';

    if (bookings.length === 0) {
      bookingsList.innerHTML = '<p>No upcoming bookings.</p>';
      return;
    }

    // Filter only future bookings or today
    const todayDate = new Date().toISOString().split('T')[0];
    const futureBookings = bookings.filter(booking => booking.date >= todayDate);

    if (futureBookings.length === 0) {
      bookingsList.innerHTML = '<p>No upcoming bookings.</p>';
      return;
    }

    futureBookings.forEach(booking => {
      const bookingItem = document.createElement('div');
      bookingItem.classList.add('booking-item');

      const bookingDetails = document.createElement('div');
      bookingDetails.classList.add('booking-details');

      const bookingDate = new Date(booking.date);
      const formattedDate = bookingDate.toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });

      bookingDetails.innerHTML = `
        <h3>${booking.range_type}</h3>
        <p><strong>Date:</strong> ${formattedDate}</p>
        <p><strong>Time:</strong> ${formatTimeSlot(booking.time_slot)}</p>
        <p><strong>Name:</strong> ${booking.name}</p>
      `;

      const bookingActions = document.createElement('div');
      bookingActions.classList.add('booking-actions');

      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'Cancel';
      cancelButton.addEventListener('click', () => cancelBooking(booking.id));

      bookingActions.appendChild(cancelButton);
      bookingItem.appendChild(bookingDetails);
      bookingItem.appendChild(bookingActions);
      bookingsList.appendChild(bookingItem);
    });
  }

  // Cancel a booking
  async function cancelBooking(bookingId) {
    // Get password from session storage or prompt
    let password = sessionStorage.getItem('rangeBookingPassword');

    // If no password in session storage, prompt for it
    if (!password) {
      password = prompt('Please enter your booking password to confirm cancellation:');
      if (!password) return; // User canceled the prompt
    }

    if (!confirm('Are you sure you want to cancel this booking?')) return;

    try {
      const email = localStorage.getItem('rangeBookingEmail');

      // Delete booking through API with password verification
      const response = await fetch(`${API_URL}?id=${bookingId}&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
        method: 'DELETE'
      });

      if (!response.ok) {
        // If unauthorized (wrong password), prompt again
        if (response.status === 401) {
          sessionStorage.removeItem('rangeBookingPassword'); // Clear invalid password
          alert('Invalid password. Please try again.');
          // Try again with new password
          cancelBooking(bookingId);
          return;
        }

        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to cancel booking');
      }

      // Refresh user bookings with the saved password
      const viewEmail = document.getElementById('view-email');
      const viewPassword = document.getElementById('view-password');

      // Set the form fields if they're empty
      if (!viewEmail.value) viewEmail.value = email;
      if (!viewPassword.value) viewPassword.value = password;

      // Refresh the bookings
      await viewBookingsWithPassword();

      // If we're viewing availability for the same date/range, refresh it
      if (dateInput.value && rangeTypeInput.value) {
        await checkAvailability();
      }

      alert('Booking cancelled successfully.');
    } catch (err) {
      console.error('Error cancelling booking:', err);
      alert(err.message || 'Failed to cancel booking. Please try again.');
    }
  }

  // Helper: Reset the booking form
  function resetForm() {
    // Keep the name and email
    dateInput.value = '';
    rangeTypeInput.value = '';
    selectedTimeSlot = null;
    timeSlotsContainer.innerHTML = '<div class="loading">Select a date and range type to see available slots</div>';
    bookButton.disabled = true;

    // Remove selected slot class
    document.querySelectorAll('.slot.selected').forEach(el => {
      el.classList.remove('selected');
    });
  }

  // Helper: Validate form inputs
  function validateForm() {
    if (!nameInput.value || !emailInput.value || !dateInput.value ||
            !rangeTypeInput.value || !selectedTimeSlot) {
      errorMessage.textContent = 'Please fill out all fields and select a time slot.';
      errorMessage.style.display = 'block';
      return false;
    }
    return true;
  }

  // Helper: Format time slot for display
  function formatTimeSlot(timeSlot) {
    if (!timeSlot) return '';

    const [start, end] = timeSlot.split('-');

    // Convert 24h to 12h format
    const formatHour = (hour) => {
      const [h, m] = hour.split(':');
      const hour12 = h % 12 || 12;
      const ampm = h < 12 ? 'AM' : 'PM';
      return `${hour12}:${m} ${ampm}`;
    };

    return `${formatHour(start)} - ${formatHour(end)}`;
  }
</script>
</body>
</html>