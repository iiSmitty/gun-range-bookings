<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>.22 and Rifle Range Booking System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }

    body {
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    header {
      background-color: #2c3e50;
      color: #fff;
      padding: 20px;
      text-align: center;
      margin-bottom: 30px;
      border-radius: 5px;
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
    }

    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      background-color: #ecf0f1;
      cursor: pointer;
      border: 1px solid #ddd;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    .tab:first-child {
      border-radius: 5px 0 0 5px;
    }

    .tab:last-child {
      border-radius: 0 5px 5px 0;
    }

    .tab.active {
      background-color: #2c3e50;
      color: white;
      border-color: #2c3e50;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .auth-container {
      background-color: #fff;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .auth-container.logged-in {
      background-color: #e8f5e9;
      border-left: 5px solid #4caf50;
    }

    .form-container, .bookings-container {
      background-color: #fff;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h2 {
      margin-bottom: 20px;
      color: #2c3e50;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }

    h3 {
      color: #2c3e50;
      margin-bottom: 10px;
    }

    form {
      display: flex;
      flex-direction: column;
    }

    label {
      margin-bottom: 5px;
      font-weight: bold;
    }

    input, select {
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      background-color: #2c3e50;
      color: #fff;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      border-radius: 4px;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #1a252f;
    }

    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }

    button.secondary {
      background-color: #7f8c8d;
    }

    button.secondary:hover {
      background-color: #6c7a7c;
    }

    button.danger {
      background-color: #e74c3c;
    }

    button.danger:hover {
      background-color: #c0392b;
    }

    .booking-item {
      padding: 15px;
      border-left: 4px solid #3498db;
      border-radius: 3px;
      margin-bottom: 15px;
      background-color: #f8f9fa;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .booking-details {
      flex: 1;
    }

    .booking-actions button {
      padding: 8px 12px;
    }

    .error-message {
      color: #e74c3c;
      font-weight: bold;
      margin-top: 10px;
      display: none;
    }

    .loading {
      text-align: center;
      padding: 20px;
      font-style: italic;
      color: #7f8c8d;
    }

    .no-bookings {
      text-align: center;
      padding: 30px;
      background-color: #f8f9fa;
      border-radius: 5px;
      color: #7f8c8d;
    }

    .login-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-info {
      font-weight: bold;
    }

    .slots-container {
      margin-top: 20px;
    }

    .time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .slot {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .slot:hover:not(.slot-full) {
      background-color: #ecf0f1;
    }

    .slot.selected {
      background-color: #3498db;
      color: white;
      border-color: #2980b9;
    }

    .slot-full {
      background-color: #f5f5f5;
      color: #95a5a6;
      cursor: not-allowed;
      text-decoration: line-through;
    }

    .capacity-indicator {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      font-size: 0.8em;
    }

    .capacity-bar {
      height: 5px;
      width: 100%;
      background-color: #ecf0f1;
      border-radius: 2px;
      margin-top: 5px;
      overflow: hidden;
    }

    .capacity-fill {
      height: 100%;
      background-color: #2ecc71;
      transition: width 0.3s;
    }

    .capacity-warning .capacity-fill {
      background-color: #f39c12;
    }

    .capacity-full .capacity-fill {
      background-color: #e74c3c;
    }

    .field-hint {
      font-size: 0.8em;
      color: #666;
      margin-top: -10px;
      margin-bottom: 15px;
    }

    @media (max-width: 768px) {
      .time-slots {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>.22 and Rifle Range Booking System</h1>
    <p>Book your shooting sessions online</p>
  </header>

  <!-- Login/Registration Section -->
  <div id="auth-container" class="auth-container">
    <div id="login-form">
      <h3>Login or Register</h3>
      <form id="auth-form">
        <label for="auth-email">Email:</label>
        <input type="email" id="auth-email" required>

        <label for="auth-password">Password:</label>
        <input type="password" id="auth-password" required>
        <p class="field-hint">Create a password to secure your bookings or enter your existing one.</p>

        <label for="auth-name">Full Name:</label>
        <input type="text" id="auth-name" required>
        <p class="field-hint">Required for new registrations.</p>

        <div id="auth-error" class="error-message"></div>

        <button type="button" id="login-button">Login / Register</button>
      </form>
    </div>

    <div id="logged-in-view" style="display:none;">
      <div class="login-info">
        <div class="user-info">
          Logged in as: <span id="user-email-display"></span>
        </div>
        <button type="button" id="logout-button" class="secondary">Logout</button>
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tabs">
    <div class="tab active" data-tab="make-booking">Make a Booking</div>
    <div class="tab" data-tab="view-bookings">View My Bookings</div>
  </div>

  <!-- Tab Content -->
  <div id="make-booking" class="tab-content active">
    <div class="form-container">
      <h2>Make a Booking</h2>
      <form id="booking-form">
        <label for="date">Date:</label>
        <input type="date" id="date" required>

        <label for="range-type">Range Type:</label>
        <select id="range-type" required>
          <option value="">Select range type</option>
          <option value=".22 Range">.22 Range</option>
          <option value="Rifle Range">Rifle Range</option>
        </select>

        <div class="slots-container">
          <label>Available Time Slots:</label>
          <div id="time-slots" class="time-slots">
            <div class="loading">Select a date and range type to see available slots</div>
          </div>
        </div>

        <div id="booking-error" class="error-message"></div>

        <button type="button" id="book-button" disabled>Book Range Time</button>
      </form>
    </div>
  </div>

  <div id="view-bookings" class="tab-content">
    <div class="bookings-container">
      <h2>Your Bookings</h2>
      <div id="bookings-list" class="loading">
        Login to view your bookings...
      </div>
    </div>
  </div>
</div>

<script>
  // API endpoint - update this to your Netlify function URL
  const API_URL = 'https://kraaifonteinrangebookings.netlify.app/.netlify/functions/bookings';

  // Configuration
  const MAX_CAPACITY = {
    ".22 Range": 5,  // 5 people per time slot
    "Rifle Range": 3  // 3 people per time slot
  };

  const TIME_SLOTS = [
    "09:00-10:00",
    "10:00-11:00",
    "11:00-12:00",
    "12:00-13:00",
    "13:00-14:00",
    "14:00-15:00",
    "15:00-16:00",
    "16:00-17:00"
  ];

  // User state
  let currentUser = {
    email: null,
    name: null,
    isLoggedIn: false
  };

  let selectedTimeSlot = null;

  // DOM Elements
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');
  const authContainer = document.getElementById('auth-container');
  const loginForm = document.getElementById('login-form');
  const loggedInView = document.getElementById('logged-in-view');
  const userEmailDisplay = document.getElementById('user-email-display');
  const authEmailInput = document.getElementById('auth-email');
  const authPasswordInput = document.getElementById('auth-password');
  const authNameInput = document.getElementById('auth-name');
  const loginButton = document.getElementById('login-button');
  const logoutButton = document.getElementById('logout-button');
  const dateInput = document.getElementById('date');
  const rangeTypeInput = document.getElementById('range-type');
  const timeSlotsContainer = document.getElementById('time-slots');
  const bookButton = document.getElementById('book-button');
  const bookingsList = document.getElementById('bookings-list');
  const authError = document.getElementById('auth-error');
  const bookingError = document.getElementById('booking-error');

  // Event Listeners
  document.addEventListener('DOMContentLoaded', initialize);
  loginButton.addEventListener('click', handleAuth);
  logoutButton.addEventListener('click', handleLogout);
  dateInput.addEventListener('change', checkAvailability);
  rangeTypeInput.addEventListener('change', checkAvailability);
  bookButton.addEventListener('click', createBooking);

  // Tab switching
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Only allow tab switching if logged in
      if (!currentUser.isLoggedIn && tab.dataset.tab === 'view-bookings') {
        alert('Please login first to view your bookings');
        return;
      }

      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      tabContents.forEach(content => {
        content.classList.remove('active');
      });

      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });

  // Set minimum date to today
  const today = new Date().toISOString().split('T')[0];
  dateInput.setAttribute('min', today);

  // Initialize application
  async function initialize() {
    // Check if user is already logged in
    const storedEmail = localStorage.getItem('rangeBookingEmail');
    const storedName = localStorage.getItem('rangeBookingName');
    const storedPassword = sessionStorage.getItem('rangeBookingPassword');

    if (storedEmail && storedPassword) {
      // Try to verify the stored credentials
      authEmailInput.value = storedEmail;
      authPasswordInput.value = storedPassword;
      if (storedName) authNameInput.value = storedName;

      // Attempt to login with stored credentials
      await handleAuth(true);
    }
  }

  // Handle authentication (login/register)
  async function handleAuth(skipPrompts = false) {
    const email = authEmailInput.value.trim();
    const password = authPasswordInput.value.trim();
    const name = authNameInput.value.trim();

    // Validate inputs
    if (!email) {
      showError(authError, 'Email is required');
      return;
    }

    if (!password || password.length < 4) {
      showError(authError, 'Password must be at least 4 characters');
      return;
    }

    if (!skipPrompts) {
      loginButton.textContent = 'Verifying...';
      loginButton.disabled = true;
    }

    try {
      // Try to verify credentials
      const response = await fetch(`${API_URL}/verify?email=${encodeURIComponent(email.toLowerCase())}&password=${encodeURIComponent(password)}`);

      if (response.ok) {
        // Successful login
        const data = await response.json();

        // Store credentials
        localStorage.setItem('rangeBookingEmail', email);
        sessionStorage.setItem('rangeBookingPassword', password);

        // Set user state
        currentUser = {
          email: email,
          name: data[0]?.name || name,
          isLoggedIn: true
        };

        if (currentUser.name) {
          localStorage.setItem('rangeBookingName', currentUser.name);
        }

        // Update UI
        updateUIAfterLogin();

        // Load bookings
        loadBookings();
      } else if (response.status === 401) {
        // User not found - this could be a new registration
        if (!name) {
          showError(authError, 'Please enter your full name to register');
          return;
        }

        if (!skipPrompts) {
          const confirmRegister = confirm('No account found with these credentials. Would you like to register?');
          if (!confirmRegister) {
            loginButton.textContent = 'Login / Register';
            loginButton.disabled = false;
            return;
          }
        }

        // Store the user info for use in the first booking
        localStorage.setItem('rangeBookingEmail', email);
        localStorage.setItem('rangeBookingName', name);
        sessionStorage.setItem('rangeBookingPassword', password);

        // Set user state
        currentUser = {
          email: email,
          name: name,
          isLoggedIn: true
        };

        // Update UI
        updateUIAfterLogin();

        // Show no bookings yet
        bookingsList.innerHTML = '<div class="no-bookings">No bookings found. Make your first booking now!</div>';
      } else {
        // Other error
        const errorData = await response.json();
        throw new Error(errorData.error || 'Authentication failed');
      }
    } catch (error) {
      console.error('Authentication error:', error);
      showError(authError, error.message || 'Failed to authenticate');
    } finally {
      if (!skipPrompts) {
        loginButton.textContent = 'Login / Register';
        loginButton.disabled = false;
      }
    }
  }

  // Update UI after successful login
  function updateUIAfterLogin() {
    // Show logged in view
    loginForm.style.display = 'none';
    loggedInView.style.display = 'block';
    authContainer.classList.add('logged-in');

    // Update user display
    userEmailDisplay.textContent = currentUser.email;

    // Clear any auth errors
    authError.style.display = 'none';
  }

  // Handle logout
  function handleLogout() {
    // Clear session storage (but keep email in local storage for convenience)
    sessionStorage.removeItem('rangeBookingPassword');

    // Reset user state
    currentUser = {
      email: null,
      name: null,
      isLoggedIn: false
    };

    // Reset UI
    loginForm.style.display = 'block';
    loggedInView.style.display = 'none';
    authContainer.classList.remove('logged-in');

    // Reset booking list
    bookingsList.innerHTML = '<div class="loading">Login to view your bookings...</div>';

    // Switch to booking tab
    tabs[0].click();
  }

  // Load user bookings
  async function loadBookings() {
    if (!currentUser.isLoggedIn) return;

    bookingsList.innerHTML = '<div class="loading">Loading your bookings...</div>';

    try {
      // Get bookings for the current user
      const response = await fetch(`${API_URL}/verify?email=${encodeURIComponent(currentUser.email)}&password=${encodeURIComponent(sessionStorage.getItem('rangeBookingPassword'))}`);

      if (!response.ok) {
        throw new Error('Failed to load bookings');
      }

      const bookings = await response.json();
      renderBookings(bookings);
    } catch (error) {
      console.error('Error loading bookings:', error);
      bookingsList.innerHTML = '<div class="error-message">Failed to load your bookings. Please try again.</div>';
    }
  }

  // Render bookings list
  function renderBookings(bookings) {
    bookingsList.innerHTML = '';

    if (!bookings || bookings.length === 0) {
      bookingsList.innerHTML = '<div class="no-bookings">No upcoming bookings found.</div>';
      return;
    }

    // Filter only future bookings or today
    const todayDate = new Date().toISOString().split('T')[0];
    const futureBookings = bookings.filter(booking => booking.date >= todayDate);

    if (futureBookings.length === 0) {
      bookingsList.innerHTML = '<div class="no-bookings">No upcoming bookings found.</div>';
      return;
    }

    // Sort bookings by date and time
    futureBookings.sort((a, b) => {
      if (a.date === b.date) {
        return a.time_slot.localeCompare(b.time_slot);
      }
      return a.date.localeCompare(b.date);
    });

    // Create booking items
    futureBookings.forEach(booking => {
      const bookingItem = document.createElement('div');
      bookingItem.classList.add('booking-item');

      const bookingDate = new Date(booking.date);
      const formattedDate = bookingDate.toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });

      const bookingDetails = document.createElement('div');
      bookingDetails.classList.add('booking-details');
      bookingDetails.innerHTML = `
        <h3>${booking.range_type}</h3>
        <p><strong>Date:</strong> ${formattedDate}</p>
        <p><strong>Time:</strong> ${formatTimeSlot(booking.time_slot)}</p>
      `;

      const bookingActions = document.createElement('div');
      bookingActions.classList.add('booking-actions');

      const cancelButton = document.createElement('button');
      cancelButton.classList.add('danger');
      cancelButton.textContent = 'Cancel Booking';
      cancelButton.addEventListener('click', () => cancelBooking(booking.id));

      bookingActions.appendChild(cancelButton);
      bookingItem.appendChild(bookingDetails);
      bookingItem.appendChild(bookingActions);
      bookingsList.appendChild(bookingItem);
    });
  }

  // Check availability for the selected date and range
  async function checkAvailability() {
    // Reset state
    timeSlotsContainer.innerHTML = '<div class="loading">Loading available slots...</div>';
    selectedTimeSlot = null;
    bookButton.disabled = true;
    bookingError.style.display = 'none';

    const date = dateInput.value;
    const rangeType = rangeTypeInput.value;

    if (!date || !rangeType) {
      timeSlotsContainer.innerHTML = '<div class="loading">Select a date and range type to see available slots</div>';
      return;
    }

    try {
      // Get current bookings for this date and range
      const response = await fetch(`${API_URL}?date=${date}&rangeType=${encodeURIComponent(rangeType)}`);

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to load availability');
      }

      const bookings = await response.json();
      renderTimeSlots(bookings || [], date, rangeType);
    } catch (error) {
      console.error('Error checking availability:', error);
      showError(bookingError, error.message || 'Failed to load availability');
      timeSlotsContainer.innerHTML = '';
    }
  }

  // Render available time slots
  function renderTimeSlots(bookings, date, rangeType) {
    timeSlotsContainer.innerHTML = '';

    // Group bookings by time slot
    const bookingsBySlot = {};
    TIME_SLOTS.forEach(slot => {
      bookingsBySlot[slot] = 0;
    });

    // Count bookings per slot
    bookings.forEach(booking => {
      if (bookingsBySlot.hasOwnProperty(booking.time_slot)) {
        bookingsBySlot[booking.time_slot]++;
      }
    });

    // Create slot elements
    TIME_SLOTS.forEach(timeSlot => {
      const slot = document.createElement('div');
      const bookedCount = bookingsBySlot[timeSlot];
      const maxCapacity = MAX_CAPACITY[rangeType];
      const isFull = bookedCount >= maxCapacity;

      slot.className = `slot ${isFull ? 'slot-full' : ''}`;
      slot.dataset.timeSlot = timeSlot;

      // Calculate capacity percentage
      const capacityPercentage = (bookedCount / maxCapacity) * 100;
      let capacityClass = '';

      if (capacityPercentage >= 100) {
        capacityClass = 'capacity-full';
      } else if (capacityPercentage >= 70) {
        capacityClass = 'capacity-warning';
      }

      slot.innerHTML = `
        <div>${formatTimeSlot(timeSlot)}</div>
        <div class="capacity-indicator">
          <span>${bookedCount}/${maxCapacity} booked</span>
        </div>
        <div class="capacity-bar ${capacityClass}">
          <div class="capacity-fill" style="width: ${Math.min(capacityPercentage, 100)}%"></div>
        </div>
      `;

      if (!isFull) {
        slot.addEventListener('click', () => selectTimeSlot(slot, timeSlot));
      }

      timeSlotsContainer.appendChild(slot);
    });

    if (timeSlotsContainer.children.length === 0) {
      timeSlotsContainer.innerHTML = '<p>No time slots available for the selected date.</p>';
    }
  }

  // Select a time slot
  function selectTimeSlot(slotElement, timeSlot) {
    // First check if user is logged in
    if (!currentUser.isLoggedIn) {
      alert('Please login or register first before booking');
      authEmailInput.focus();
      return;
    }

    // Remove selection from all slots
    document.querySelectorAll('.slot.selected').forEach(el => {
      el.classList.remove('selected');
    });

    // Add selection to clicked slot
    slotElement.classList.add('selected');
    selectedTimeSlot = timeSlot;

    // Enable booking button
    bookButton.disabled = false;
  }

  // Create a new booking
  async function createBooking() {
    if (!currentUser.isLoggedIn) {
      showError(bookingError, 'Please login or register first');
      return;
    }

    const date = dateInput.value;
    const rangeType = rangeTypeInput.value;

    if (!date || !rangeType || !selectedTimeSlot) {
      showError(bookingError, 'Please select a date, range type, and time slot');
      return;
    }

    // Show loading state
    bookButton.disabled = true;
    bookButton.textContent = 'Processing...';
    bookingError.style.display = 'none';

    try {
      // Get password from session storage
      const password = sessionStorage.getItem('rangeBookingPassword');

      if (!password) {
        throw new Error('Session expired. Please login again');
      }

      // Create the booking
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: currentUser.name,
          email: currentUser.email,
          date: date,
          rangeType: rangeType,
          timeSlot: selectedTimeSlot,
          password: password
        })
      });

      // Handle different response statuses
      if (response.status === 409) {
        throw new Error('This time slot is now fully booked. Please select another time.');
      }

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to create booking');
      }

      // Booking successful
      alert('Booking confirmed successfully!');

      // Reset form
      dateInput.value = '';
      rangeTypeInput.value = '';
      selectedTimeSlot = null;
      timeSlotsContainer.innerHTML = '<div class="loading">Select a date and range type to see available slots</div>';

      // Refresh bookings list
      loadBookings();

      // Switch to bookings tab
      tabs[1].click();
    } catch (error) {
      console.error('Error creating booking:', error);
      showError(bookingError, error.message || 'Failed to create booking');
    } finally {
      bookButton.disabled = false;
      bookButton.textContent = 'Book Range Time';
    }
  }

  // Cancel a booking
  async function cancelBooking(bookingId) {
    if (!confirm('Are you sure you want to cancel this booking?')) return;

    try {
      const password = sessionStorage.getItem('rangeBookingPassword');

      if (!password) {
        throw new Error('Session expired. Please login again');
      }

      // Delete the booking
      const response = await fetch(`${API_URL}?id=${bookingId}&email=${encodeURIComponent(currentUser.email)}&password=${encodeURIComponent(password)}`, {
        method: 'DELETE'
      });

      if (!response.ok) {
        if (response.status === 401) {
          sessionStorage.removeItem('rangeBookingPassword');
          handleLogout();
          throw new Error('Session expired. Please login again');
        }

        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to cancel booking');
      }

      // Success
      alert('Booking cancelled successfully');

      // Refresh bookings
      loadBookings();
    } catch (error) {
      console.error('Error cancelling booking:', error);
      alert(error.message || 'Failed to cancel booking');
    }
  }

  // Helper function: Show error message
  function showError(element, message) {
    element.textContent = message;
    element.style.display = 'block';
  }

  // Helper function: Format time slot
  function formatTimeSlot(timeSlot) {
    if (!timeSlot) return '';

    const [start, end] = timeSlot.split('-');

    // Convert 24h to 12h format
    const formatHour = (hour) => {
      const [h, m] = hour.split(':');
      const hour12 = h % 12 || 12;
      const ampm = h < 12 ? 'AM' : 'PM';
      return `${hour12}:${m} ${ampm}`;
    };

    return `${formatHour(start)} - ${formatHour(end)}`;
  }
</script>
</body>
</html>